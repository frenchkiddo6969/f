<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>weimc - FM transmitter maps</title>
  <link rel="icon" href="https://maps.fmdx.org/old/favicon.ico" type="image/ico">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;font-family:Tahoma,Arial,sans-serif;font-size:11px}
    #map{position:absolute;top:0;left:0;right:0;bottom:0;z-index:0}
    #radio-map-panel{position:absolute;top:10px;left:10px;width:380px;background:#fff;border:1px solid #777;box-shadow:2px 2px 5px rgba(0,0,0,.3);z-index:2000;max-height:90vh;display:flex;flex-direction:column}
    .panel-header{background:#f0f0f0;padding:5px 10px;border-bottom:1px solid #aaa;font-weight:bold;text-align:center;font-size:14px;position:relative;cursor:move}
    .min-btn{position:absolute;right:5px;top:5px;width:20px;height:20px;background:#fff;border:1px solid #777;text-align:center;line-height:18px;cursor:pointer;font-weight:bold}
    .dev-btn{position:absolute;right:30px;top:5px;width:20px;height:20px;background:#fff;border:1px solid #777;text-align:center;line-height:18px;cursor:pointer;font-weight:bold}
    #panel-content-container{overflow-y:auto;flex-grow:1;padding:5px}
    .filter-row{display:flex;justify-content:space-between;align-items:center;padding:2px 5px;margin-bottom:2px}
    .filter-group{display:flex;align-items:center;gap:4px}
    .inp-short{width:40px}.inp-med{width:60px}
    .status-line{text-align:center;padding:5px;border-top:1px dotted #aaa;border-bottom:1px dotted #aaa;margin:5px 0;font-style:italic}
    .tx-block{margin-bottom:15px;border:1px solid #ccc;background:#fff}
    .tx-header{background:#f8f8f8;padding:5px;text-align:center;font-weight:bold;border-bottom:1px solid #ccc;font-size:12px}
    .tx-subheader{text-align:center;font-size:10px;color:#555;padding-bottom:4px;border-bottom:1px solid #eee;background:#fff}
    table.station-table{width:100%;border-collapse:collapse}
    table.station-table th{background:#e1e1e1;text-align:left;padding:3px;border:1px solid #ccc;font-weight:bold}
    table.station-table td{Padding:2px 3px;border:1px solid #eee;vertical-align:middle}
    tr.station-row:nth-child(even){background:#f9f9f9}
    tr.row-highlight{background:#fff6a5!important;border:1px solid #bba000}
    .freq-clickable,.station-name-clickable{color:#0000EE;text-decoration:underline;cursor:pointer}
    button.cov-btn{padding:1px 4px;font-size:9px;cursor:pointer}
    .station-inline-actions{display:flex;gap:4px;align-items:center}
    .station-inline-actions button{padding:2px 4px;font-size:10px;cursor:pointer}
    .legend-container{text-align:center;padding:10px;line-height:1.8em}
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border:1px solid #777;padding:12px;z-index:4000;display:none;max-width:90vw;max-height:80vh;overflow:auto;box-shadow:0 4px 16px rgba(0,0,0,.3)}
    .modal input,.modal select{margin-bottom:6px;width:100%;box-sizing:border-box}
    .modal .row{display:flex;gap:6px}
    .btn{padding:4px 6px;cursor:pointer;font-size:12px}
    /* tooltip style restored */
    .tooltip-box {
      position: absolute;
      pointer-events: none;
      background: rgba(255,255,255,0.95);
      padding: 6px 8px;
      border: 1px solid #666;
      font-size: 12px;
      z-index: 6000;
      white-space: nowrap;
      transition: opacity .12s, transform .12s;
      opacity: 0;
      box-shadow: 0 1px 6px rgba(0,0,0,0.12);
      border-radius: 4px;
    }
    /* debug badge */
    #debug-badge{position:fixed;right:10px;bottom:10px;background:rgba(0,0,0,.6);color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;z-index:6000}
    .freq-step-btn {padding:2px 6px;font-size:12px;line-height:1;border:1px solid #777;background:#fff;cursor:pointer}

    /* ---- new styles for disabled stations ---- */
    .station-disabled { text-decoration: line-through; opacity: 0.6; color: #666; }
    .cov-btn[disabled] { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  <div id="radio-map-panel">
    <div class="panel-header" id="panel-drag-handle">
      weimc - FM transmitter maps
      <div class="dev-btn" id="devtools-toggle" title="Devtools">âš™</div>
      <div class="min-btn" id="panel-min-btn">-</div>
    </div>

    <div id="panel-content-wrapper">
      <div style="padding:5px">
        <div class="filter-row">
          <div class="filter-group"><label>Country:</label><select id="country-filter"><option>All</option></select></div>
          <div class="filter-group" style="margin-left:auto">
            <label>Freq:</label>
            <button id="freq-dec" class="freq-step-btn" title="Decrease 0.1 MHz">-</button>
            <input id="freq-filter-inp" class="inp-med" placeholder="MHz" style="text-align:center">
            <button id="freq-inc" class="freq-step-btn" title="Increase 0.1 MHz">+</button>
          </div>
        </div>
        <div class="filter-row" style="justify-content:center;gap:15px"><label><input type="checkbox" checked> Keep position</label><label><input type="checkbox"> Dark mode</label></div>
        <div class="filter-row" style="justify-content:center;gap:10px;border-bottom:1px solid #ccc;padding-bottom:5px">
          <div class="filter-group"><label>ERP â‰¥</label><input id="eirp-filter-inp" class="inp-short" type="number" placeholder="kW"><button class="btn" onclick="document.getElementById('eirp-filter-inp').value=''; applyFiltersGlobal()">X</button></div>
          <div class="filter-group"><label>Pol:</label><select id="pol-filter"><option>Any</option><option>H</option><option>V</option><option>C</option><option>O</option></select><button class="btn" onclick="document.getElementById('pol-filter').value='Any'; applyFiltersGlobal()">X</button></div>
          <div class="filter-group"><label>PI:</label><input id="pi-filter-inp" class="inp-short" placeholder="Hex"><button class="btn" onclick="document.getElementById('pi-filter-inp').value=''; applyFiltersGlobal()">X</button></div>
        </div>
        <div style="display:flex;justify-content:center;gap:10px;padding-top:6px"><label style="font-weight:normal"><input id="marked-only" type="checkbox"> Show marked only</label></div>
        <div id="status-line-container" class="status-line">All 0 locations are currently visible</div>
      </div>

      <div id="panel-content-container"></div>

      <div id="devtools-panel" style="display:none;border-top:1px solid #ccc;padding:6px;background:#fafafa;max-height:50vh;overflow:auto">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="font-weight:bold">Devtools / Editor</div>
          <div style="display:flex;gap:6px">
            <button class="btn" id="dev-add-tx">Add TX</button>
            <button class="btn" id="dev-export">Export JSON</button>
            <button class="btn" id="dev-import">Import JSON</button>
          </div>
        </div>
        <div class="devtools-list" id="devtools-list"></div>
        <div style="margin-top:6px;font-size:11px;color:#555">Tip: click Edit to modify TX/stations. Add TX -> click on the map to place.</div>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <div class="modal" id="edit-modal" role="dialog" aria-hidden="true">
    <div style="font-weight:bold;margin-bottom:6px" id="edit-modal-title">Edit</div>
    <div id="edit-modal-body"></div>
    <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:8px">
      <button class="btn" id="edit-save">Save</button>
      <button class="btn" id="edit-cancel">Cancel</button>
    </div>
  </div>

  <div id="debug-badge">TXs: 0</div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
  (function(){
    const map = L.map('map', { crs: L.CRS.Simple, minZoom:-5, maxZoom:2, zoomSnap:0.1, zoomControl:false });
    L.control.zoom({ position:'topright' }).addTo(map);
    if (!map.getPane('coveragePane')) map.createPane('coveragePane'); map.getPane('coveragePane').style.zIndex = 450;
    if (!map.getPane('trailPane')) map.createPane('trailPane'); map.getPane('trailPane').style.zIndex = 500;

    const MAIN_WIDTH_UNITS = 15904, MAIN_HEIGHT_UNITS = 15968;
    const mainImgUrl = 'https://i.soupco.net/raw/ssSkCG.png';
    const mainBounds = [[0,0],[MAIN_WIDTH_UNITS,MAIN_HEIGHT_UNITS]];
    L.imageOverlay(mainImgUrl, mainBounds, { interactive:false, opacity:1, zIndex:500 }).addTo(map);
    map.fitBounds(mainBounds);

    const iconBase = 'https://maps.fmdx.org/old/img/';
    const icons = {
      low: L.icon({ iconUrl: iconBase+'tx-lo.png', iconSize:[19,19], iconAnchor:[9.5,19] }),
      med: L.icon({ iconUrl: iconBase+'tx-med.png', iconSize:[23,23], iconAnchor:[11.5,23] }),
      high: L.icon({ iconUrl: iconBase+'tx-hi.png', iconSize:[27,27], iconAnchor:[13.5,27] }),
      lowSel: L.icon({ iconUrl: iconBase+'tx-lo-sel.png', iconSize:[19,19], iconAnchor:[9.5,19] }),
      medSel: L.icon({ iconUrl: iconBase+'tx-med-sel.png', iconSize:[23,23], iconAnchor:[11.5,23] }),
      highSel: L.icon({ iconUrl: iconBase+'tx-hi-sel.png', iconSize:[27,27], iconAnchor:[13.5,27] }),
      rx: L.icon({ iconUrl: iconBase+'rx.png', iconSize:[34,26], iconAnchor:[17,26] })
    };

    const tooltipOffsets = { lo:{x:0,y:0}, med:{x:0,y:0}, hi:{x:0,y:0} };

    let txList = [];
    const uidToTx = new Map();
    let uidCounter = 1;
    let rx = null;
    let filterFreq = null, filterPI = null, filterEIRP = null, filterStationName = null;
    let polFilter = 'Any', markedOnly = false;
    const selectedIDs = new Set();
    let devMode = false;
    let awaitingNewTxPlacement = false;

    const panelContentContainer = document.getElementById('panel-content-container');
    const devToggle = document.getElementById('devtools-toggle');
    const devPanel = document.getElementById('devtools-panel');
    const devList = document.getElementById('devtools-list');
    const statusLineContainer = document.getElementById('status-line-container');
    const debugBadge = document.getElementById('debug-badge');

    function seedFromString(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++) h=Math.imul(h^str.charCodeAt(i),16777619)>>>0; return h; }
    function mulberry32(a){ return function(){ a|=0; a=(a+0x6D2B79F5)|0; let t=Math.imul(a^a>>>15,1|a); t=(t+Math.imul(t^t>>>7,61|t))^t; return ((t^t>>>14)>>>0)/4294967296; }; }
    function colorForTx(tx){ const seedStr = String(tx.__uid||tx.id||tx.name||Math.random()); const rnd = mulberry32(seedFromString(seedStr)); const hue = Math.floor(rnd()*360); return { stroke:`hsl(${hue} 75% 25%)`, fill:`hsl(${hue} 70% 55%)` }; }
    function isDirectionalFlag(v){ if(v===true) return true; if(v===false||v===null||typeof v==='undefined') return false; if(typeof v==='number') return v===1; if(typeof v==='string'){ const t=v.trim().toUpperCase(); return t==='Y'||t==='YES'||t==='TRUE'||t==='1'; } return false; }

    function degToRad(d){ return d*Math.PI/180; }
    function kW_to_km_radius(kw){ const k=Number(kw)||0; if(k<=0) return 0; const log=Math.log10(k); const radius = -3*(log*log) + 37.5*log + 65; return Math.max(0,radius); }

    // helper: format freq to 1 decimal (90.1 not 90.100)
    function formatFreqOneDecimal(v){
      const n = Number(v);
      if(!isFinite(n)) return '';
      return (Math.round(n*10)/10).toFixed(1);
    }

    // --- new helpers for band-aware formatting / snapping ---
    const OIRT_MIN = 65.8, OIRT_MAX = 74.0, OIRT_STEP = 0.03; // 30 kHz OIRT
    const NWR_CHANNELS = [162.400,162.425,162.450,162.475,162.500,162.525,162.550];

    function isInOirtBand(freq){ return typeof freq==='number' && freq >= OIRT_MIN - 1e-9 && freq <= OIRT_MAX + 1e-9; }
    function isInNwrBand(freq){ return typeof freq==='number' && freq >= 162.4 - 1e-6 && freq <= 162.55 + 1e-6; }

    function roundToStep(value, step, base=0){
      const inv = Math.round((value - base) / step);
      const v = base + inv * step;
      // reduce FP error
      const decimals = Math.max(0, (step.toString().split('.')[1]||'').length);
      return Number(v.toFixed(decimals+3));
    }

    function formatForDisplayByStep(freq, step){
      if(step === 0.1) return formatFreqOneDecimal(freq);
      if(Math.abs(step - 0.03) < 1e-9) return (Math.round(freq*100)/100).toFixed(2); // OIRT -> 2 decimals (72.05)
      // for NWR show 3 decimals
      return freq.toFixed(3);
    }

    function normalizeFreqDisplay(){
      const inp = document.getElementById('freq-filter-inp');
      const v = inp.value.trim();
      if(v === '') return;
      const p = parseFloat(v);
      if(isNaN(p)){ return; }
      if(isInOirtBand(p)){
        // keep the offset the user entered; just round to 2 decimals for tidy display
        inp.value = (Math.round(p * 100) / 100).toFixed(2);
        filterFreq = Number(inp.value);
      } else if(isInNwrBand(p)){
        // snap to closest NWR channel
        let best = NWR_CHANNELS[0], bestDiff = Math.abs(p - best);
        for(let c of NWR_CHANNELS){ const d = Math.abs(p - c); if(d < bestDiff){ best = c; bestDiff = d; } }
        inp.value = best.toFixed(3);
        filterFreq = Number(inp.value);
      } else {
        // standard FM: normalize to 0.1 spacing display
        const norm = formatFreqOneDecimal(p);
        inp.value = norm;
        filterFreq = parseFloat(norm);
      }
    }

    // --- createCoveragePolygon and other code unchanged ---
    function createCoveragePolygon(centerLatLng, radiusKm, tx, stationIndex, directional=false, directionAngle=null, segments=64){
      if(!radiusKm||radiusKm<=0) return L.polygon([], { pane:'coveragePane', color:'blue', weight:2, opacity:0.6, fillOpacity:0.08 });
      const quant = Math.round(radiusKm*10), seedStr = String(tx.__uid)+'_'+quant, rnd = mulberry32(seedFromString(seedStr));
      const centerCRS = map.options.crs.project(centerLatLng);
      const latlngs=[]; const R=radiusKm;
      let dirAngle=null; if(typeof directionAngle==='number' && !isNaN(directionAngle)) dirAngle=((directionAngle%360)+360)%360;
      const bulgeDir=(directional===true && dirAngle!==null)?((dirAngle+180)%360):null;
      const coneDeg=30, maxBias=0.40, smallJitterRange=0.06;
      for(let i=0;i<segments;i++){
        const a=(i/segments)*Math.PI*2;
        const angleDeg=(90-(a*180/Math.PI)+360)%360;
        let baseRadius=R, pol=null;
        try{ const s=tx.stations && tx.stations[stationIndex]; if(s&&s.pol) pol=String(s.pol).toUpperCase(); }catch(e){pol=null;}
        if(directionally = directional === true){
          if(pol==='C'||pol==='O'){ baseRadius=R; }
          else if(pol==='H'){ const nearestVertex=Math.round(angleDeg/45)*45; let delta=Math.abs(((angleDeg-nearestVertex+540)%360)-180); if(delta>180) delta=360-delta; const t=1-Math.min(delta,22.5)/22.5; const octFactor=0.94+0.12*t; const localJitter=1+(rnd()-0.5)*0.06; baseRadius=R*octFactor*localJitter; }
          else if(pol==='V'){ if(dirAngle===null){ const delta=Math.min(Math.abs(((angleDeg-0+540)%360)-180),180); if(delta<=90) baseRadius=R*0.9; else { const theta=a; const wFactor = 1+0.18*Math.cos(4*theta); baseRadius=R*wFactor*0.85; } } else { const delta=Math.abs(((angleDeg-dirAngle+540)%360)-180); if(delta<=90) baseRadius=R*0.9; else { const relRad=degToRad(angleDeg-dirAngle+90); const wFactor=1+0.18*Math.cos(4*relRad); baseRadius=R*wFactor*0.85; } } }
          else { baseRadius=R; }
          if(dirAngle!==null){ let delta=Math.abs(((angleDeg-dirAngle+540)%360)-180); const t=(Math.cos(degToRad(delta))+1)/2; const backMin=0.2*R; baseRadius=backMin + (baseRadius-backMin)*t; }
        } else { baseRadius=R; }
        const defaultJitter = (!pol) ? 1 : 1 + (rnd()-0.5)*smallJitterRange;
        let perturb;
        if(!pol) perturb=1; else {
          if(directionally && bulgeDir!==null){
            const raw=Math.abs(((angleDeg-bulgeDir+360)%360)); const angDiff=Math.min(raw,360-raw);
            if(angDiff<=coneDeg){ const frac = 1-(angDiff/coneDeg); let combinedFrac = frac; if(rnd() < 0.35){ const offset = 8 + Math.floor(rnd()*11); const raw2 = Math.abs(((angleDeg-(bulgeDir+offset)+360)%360)); const angDiff2 = Math.min(raw2,360-raw2); let frac2 = 0; if(angDiff2 <= coneDeg) frac2 = 1-(angDiff2/coneDeg); combinedFrac = Math.max(frac, frac2); } const bias = 1 + maxBias*combinedFrac; const localJitter = 1 + (rnd()-0.5)*0.08; perturb = bias * localJitter; } else perturb = defaultJitter;
          } else perturb = defaultJitter;
        }
        const r = Math.max(0.1, baseRadius * perturb);
        const dx = Math.cos(a) * r * 10;
        const dy = Math.sin(a) * r * 10;
        const ptCRS = L.point(centerCRS.x + dx, centerCRS.y + dy);
        latlngs.push(map.options.crs.unproject(ptCRS));
      }
      const cols = colorForTx(tx);
      return L.polygon(latlngs, { pane:'coveragePane', color:cols.stroke, weight:2, opacity:0.9, fillColor:cols.fill, fillOpacity:0.25 });
    }

    function nextUID(){ return 'u' + (uidCounter++); }
    function registerTXObject(tx){ if(!tx.__uid) tx.__uid = nextUID(); uidToTx.set(tx.__uid, tx); }

    // UPDATED: prefer station-specific kW when a frequency filter is active or PI filter is active
    function updateIcon(tx){
      // prefer station selected by name, then by PI filter, then by frequency filter, then fallback to the highest-kW station
      let kwValue = null;

      // 1) if filtering by station name, use that station's kW (if present)
      if(filterStationName){
        const sMatch = (tx.stations||[]).find(s => s.name && s.name.trim().toUpperCase() === filterStationName);
        if(sMatch) kwValue = Number(sMatch.kw) || 0;
      }

      // 2) if a PI filter is active and we haven't yet chosen a station, prefer the kW of the station(s) matching that PI
      if(kwValue === null && filterPI){
        const matchesPI = (tx.stations||[]).filter(s => s.pi && String(s.pi).toUpperCase() === String(filterPI).toUpperCase());
        if(matchesPI && matchesPI.length){
          kwValue = Math.max(...matchesPI.map(s => Number(s.kw) || 0));
        }
      }

      // 3) if a frequency filter is active and we haven't yet chosen a station, prefer the kW of the station(s) matching that frequency
      if(kwValue === null && filterFreq !== null && !isNaN(filterFreq)){
        const matches = (tx.stations||[]).filter(s => s.freq !== undefined && Math.abs(Number(s.freq) - Number(filterFreq)) < 0.001);
        if(matches && matches.length){
          // take the maximum kW among stations at that frequency (handles duplicates/multi-PI)
          kwValue = Math.max(...matches.map(s => Number(s.kw) || 0));
        }
      }

      // 4) fallback: use the highest-kW station on the TX
      if(kwValue === null){
        kwValue = (tx.stations && tx.stations.length) ? Math.max(...tx.stations.map(s=>Number(s.kw)||0)) : 0;
      }

      if(kwValue >= 5) tx.iconType='hi'; else if(kwValue >= 0.5) tx.iconType='med'; else tx.iconType='lo';
      if(tx.marker) {
        const type = tx.iconType || 'lo';
        const iconToUse = selectedIDs.has(tx.id) ? (type==='hi'?icons.highSel:(type==='med'?icons.medSel:icons.lowSel)) : (type==='hi'?icons.high:(type==='med'?icons.med:icons.low));
        try{ tx.marker.setIcon(iconToUse); }catch(e){ console.warn('setIcon failed',e); }
        // if all stations are disabled, make marker more transparent
        try{ const allDisabled = (tx.stations && tx.stations.length) ? tx.stations.every(s=>!!s.disabled) : false; tx.marker.setOpacity(allDisabled?0.5:1); }catch(e){}
      }
    }

    function createTX(data, load=false){
      if(!data.stations) data.stations = [];
      (data.stations||[]).forEach(s=>{
        s.directional = isDirectionalFlag(s.directional);
        s.directionAngle = (s.directionAngle===undefined||s.directionAngle===null)?null:((isNaN(parseInt(s.directionAngle,10))?null:parseInt(s.directionAngle,10)));
        // new: normalise disabled flag
        s.disabled = !!s.disabled;
      });
      const latlng = data.latlng ? L.latLng(data.latlng[0], data.latlng[1]) : (data.point ? map.layerPointToLatLng(data.point) : L.latLng(0,0));
      const marker = L.marker(latlng, { draggable:true }).addTo(map);
      const tx = Object.assign({}, data, { marker, line:null, latlng:[latlng.lat, latlng.lng], stationCircles:{}, iconType:'lo' });
      if(!tx.id) tx.id = 'tx_' + (Date.now() + Math.floor(Math.random()*9999));
      if(tx.stations && tx.stations.length) tx.stations.sort((a,b)=> (Number(a.freq)||0) - (Number(b.freq)||0));
      registerTXObject(tx);
      txList.push(tx);
      updateIcon(tx);
      attachTxHandlers(tx);
      return tx;
    }

    function attachTxHandlers(tx){
      tx.marker.on('contextmenu', () => { if(tx.line) { try{ map.removeLayer(tx.line); }catch(e){} tx.line = null; } else drawTrail(tx); });
      tx.marker.on('click', (e) => {
        L.DomEvent.stopPropagation(e);
        if(selectedIDs.has(tx.id)){ selectedIDs.delete(tx.id); updateIcon(tx); } else {
          selectedIDs.forEach(id=>{ const t = txList.find(x=>x.id===id); if(t){ selectedIDs.delete(id); updateIcon(t); }});
          selectedIDs.add(tx.id); updateIcon(tx);
        }
        renderPanelContent();
        applyFilters();
      });
      tx.marker.on('dragend', () => { const ll = tx.marker.getLatLng(); tx.latlng = [ll.lat, ll.lng]; if(tx.line) drawTrail(tx); updateCoverageForTX(tx); renderPanelContent(); populateCountryFilter(); });
      tx.marker.on('drag', () => repositionTipForTxDuringDrag(tx));
      tx.marker.on('mouseover', () => showTip(tx));
      tx.marker.on('mouseout', hideTip);
    }

    function drawTrail(tx){ if(!rx) return; if(tx.line) try{ map.removeLayer(tx.line); }catch(e){} tx.line = L.polyline([rx.getLatLng(), tx.marker.getLatLng()], { color:'red', weight:2, opacity:0.7, pane:'trailPane' }).addTo(map); }

    // tooltip
    const tip = document.createElement('div'); tip.className = 'tooltip-box'; document.body.appendChild(tip);
    let hoveredTx = null;
    function positionTipForTx(tx){
      if(!tx) return;
      let distKm=null,bearing=null;
      if(rx){
        try{
          const crsTx = map.options.crs.project(tx.marker.getLatLng()), crsRx = map.options.crs.project(rx.getLatLng());
          const dx = crsRx.x - crsTx.x, dy = crsRx.y - crsTx.y;
          distKm = Math.round(Math.sqrt(dx*dx+dy*dy)*0.1);
          const pRx = map.latLngToContainerPoint(rx.getLatLng()), pTx = map.latLngToContainerPoint(tx.marker.getLatLng());
          bearing = Math.round((90 + Math.atan2(pTx.y - pRx.y, pTx.x - pRx.x)*180/Math.PI + 360) % 360);
        }catch(e){}
      }
      tip.innerHTML = `${escapeHtml(tx.name||tx.id)} ${distKm!==null ? 'â€“ <span style="font-weight:'+(distKm>=400?'bold':'normal')+';color:'+(distKm>=700?'red':'black')+'">'+distKm+' km</span> â€“ '+bearing+'Â°' : ''}`;
      let clientX, clientY;
      try{
        const containerRect = map.getContainer().getBoundingClientRect();
        const p = map.latLngToContainerPoint(tx.marker.getLatLng());
        const iconOptions = tx.marker && tx.marker.options && tx.marker.options.icon && tx.marker.options.icon.options;
        let iconW=null, iconH=null, anchorX=null, anchorY=null;
        if(iconOptions){
          if(Array.isArray(iconOptions.iconSize)){ iconW = Number(iconOptions.iconSize[0]); iconH = Number(iconOptions.iconSize[1]); }
          if(Array.isArray(iconOptions.iconAnchor)){ anchorX = Number(iconOptions.iconAnchor[0]); anchorY = Number(iconOptions.iconAnchor[1]); }
        }
        if(iconW && iconH && (anchorX!==null && anchorY!==null)){
          clientX = containerRect.left + (p.x - anchorX + iconW/2);
          clientY = containerRect.top + (p.y - anchorY + iconH);
        } else {
          const iconEl = tx.marker && tx.marker._icon;
          if(iconEl && iconEl.getBoundingClientRect){
            const rect = iconEl.getBoundingClientRect();
            clientX = rect.left + rect.width/2; clientY = rect.top + rect.height;
          } else {
            const mapCont = map.getContainer().getBoundingClientRect(); clientX = mapCont.left + p.x; clientY = mapCont.top + p.y;
          }
        }
      } catch(e){
        const pos = map.latLngToContainerPoint(tx.marker.getLatLng()); const containerRect = map.getContainer().getBoundingClientRect(); clientX = containerRect.left + pos.x; clientY = containerRect.top + pos.y;
      }
      const offset = tooltipOffsets[tx.iconType||'lo'];
      tip.style.left = Math.round(clientX) + 'px'; tip.style.top = Math.round(clientY + (offset?offset.y:6)) + 'px';
      tip.style.visibility='visible'; tip.style.opacity='1';
    }
    function showTip(tx){ hoveredTx = tx; positionTipForTx(tx); }
    function hideTip(){ hoveredTx=null; tip.style.visibility='hidden'; tip.style.opacity='0'; }
    function repositionTipIfNeeded(tx){ if(hoveredTx && tx && hoveredTx.__uid === tx.__uid) positionTipForTx(hoveredTx); }
    function repositionTipForTxDuringDrag(tx){ if(hoveredTx && hoveredTx.__uid === tx.__uid) positionTipForTx(tx); }
    map.on('move zoom', ()=> { if(hoveredTx) positionTipForTx(hoveredTx); });

    function toggleCoverageForStation(tx, stationIndex, btnElement){
      const s = tx.stations[stationIndex]; if(!s) return;
      // respect disabled flag
      if(s.disabled){ if(btnElement) { btnElement.style.opacity='0.5'; } return; }

      if(tx.stationCircles && tx.stationCircles[stationIndex]){ try{ map.removeLayer(tx.stationCircles[stationIndex].layer); }catch(e){} delete tx.stationCircles[stationIndex]; if(btnElement) btnElement.style.background=''; }
      else {
        const kw = Number(s.kw)||0; const radiusKm = kW_to_km_radius(kw); const dirFlag = isDirectionalFlag(s.directional);
        const poly = createCoveragePolygon(tx.marker.getLatLng(), radiusKm, tx, stationIndex, dirFlag, s.directionAngle);
        poly.addTo(map);
        if(!tx.stationCircles) tx.stationCircles={};
        tx.stationCircles[stationIndex] = { layer:poly, km:radiusKm, centerLatLng: tx.marker.getLatLng(), directional:dirFlag, directionAngle:s.directionAngle };
        if(btnElement) btnElement.style.background='#ccc';
      }
    }
    function updateCoverageForTX(tx){
      if(!tx.stationCircles) return;
      Object.keys(tx.stationCircles).forEach(idx=>{
        const sc = tx.stationCircles[idx];
        try{ map.removeLayer(sc.layer); }catch(e){}
        const s = tx.stations[idx];
        const radiusKm = sc.km || (s ? kW_to_km_radius(s.kw) : 0);
        const dirFlag = isDirectionalFlag(s? s.directional:false);
        const poly = createCoveragePolygon(tx.marker.getLatLng(), radiusKm, tx, idx, dirFlag, s && s.directionAngle);
        poly.addTo(map); sc.layer = poly;
      });
    }
    map.on('zoomend moveend', () => txList.forEach(tx=>updateCoverageForTX(tx)));

    // render panel (Add station only visible when devMode)
    function renderPanelContent(){
      debugBadge.innerText = `TXs: ${txList.length} | Visible: ${txList.filter(t=>map.hasLayer(t.marker)).length}`;
      const visible = txList.filter(tx => map.hasLayer(tx.marker));
      statusLineContainer.innerHTML = `All <b>${visible.length}</b> locations are currently visible`;

      if(selectedIDs.size === 0){
        panelContentContainer.innerHTML = `<div class="legend-container">
            <div class="legend-title">Setup your location</div>
            <div>Right-click map to set <b>QTH</b> (Home).</div>
            <div class="legend-title" style="margin-top:15px;">Mouse usage</div>
            <div>Left click: show details<br>Right click site: toggle path</div>
            <div style="margin-top:15px;text-align:left;display:inline-block">
              <div><img src="${iconBase}tx-lo.png" width="15"> - Low power (< 0.5kW ERP)</div>
              <div><img src="${iconBase}tx-med.png" width="19"> - Medium power (â‰¥ 0.5kW ERP)</div>
              <div><img src="${iconBase}tx-hi.png" width="23"> - High power (â‰¥ 5kW ERP)</div>
            </div>
          </div>`;
        return;
      }

      let html = '';
      selectedIDs.forEach(id => {
        const tx = txList.find(t => t.id === id);
        if(!tx) return;
        const uid = tx.__uid;
        let info = '';
        if(rx){
          try{
            const crsTx = map.options.crs.project(tx.marker.getLatLng()), crsRx = map.options.crs.project(rx.getLatLng());
            const dx = crsRx.x - crsTx.x, dy = crsRx.y - crsTx.y;
            const distKm = (Math.sqrt(dx*dx + dy*dy) * 0.1).toFixed(2);
            const pRx = map.latLngToContainerPoint(rx.getLatLng()), pTx = map.latLngToContainerPoint(tx.marker.getLatLng());
            const bearing = Math.round((90 + Math.atan2(pTx.y - pRx.y, pTx.x - pRx.x) * 180/Math.PI + 360) % 360);
            info = `[${distKm} km, ${bearing}Â°]`; 
          }catch(e){ info = ''; }
        } else if(tx.latlng) {
          info = `Coords: ${tx.latlng[0].toFixed(4)}, ${tx.latlng[1].toFixed(4)}`;
        }

        html += `<div class="tx-block" data-uid="${uid}">
            <div class="tx-header">${escapeHtml(tx.name||tx.id)}</div>
            <div class="tx-subheader">${escapeHtml(info)}</div>
            <div style="padding:4px 6px;">
              ${devMode ? `<button class="btn add-station-btn" data-uid="${uid}">Add station</button> <button class="btn edit-tx-btn" data-uid="${uid}">Edit TX</button><button class="btn del-tx-btn" data-uid="${uid}">Delete TX</button>` : ''}
            </div>
            <table class="station-table"><thead><tr><th>Freq</th><th>Station</th><th>PI</th><th>ERP</th><th>Cov</th></tr></thead><tbody>`;

        (tx.stations||[]).forEach((s,i)=>{
          const freqMatch = !filterFreq || (s.freq!==undefined && Math.abs(Number(s.freq)-Number(filterFreq))<0.001);
          const matchesPI = !filterPI || (s.pi && s.pi.toUpperCase() === filterPI);
          const matchesEIRP = !filterEIRP || (s.kw || 0) >= filterEIRP;
          if(!matchesPI || !matchesEIRP) return;
          const freqTxt = (s.freq||'') + (s.pol ? s.pol.charAt(0).toLowerCase() : '');
          const kwTxt = (s.kw!==undefined && s.kw!==null) ? Number(s.kw).toFixed(3) : '';
          const covActive = tx.stationCircles && tx.stationCircles[i];
          const stationActive = !!(filterStationName && s.name && s.name.trim().toUpperCase() === filterStationName);
          const rowClassBase = (filterFreq && freqMatch) ? 'station-row row-highlight' : 'station-row';
          const rowClass = stationActive ? (rowClassBase + ' row-highlight') : rowClassBase;

          // disable Cov button when station disabled
          const covBtnDisabled = s.disabled ? 'disabled' : '';

          const stationControlsHtml = devMode ? `<div class="station-inline-actions" style="display:inline-block">
                          <button class="btn edit-station-btn" data-uid="${uid}" data-idx="${i}">âœŽ</button>
                          <button class="btn delete-station-btn" data-uid="${uid}" data-idx="${i}">ðŸ—‘</button>
                        </div>` : '';

          // show strikethrough for both frequency and station name when disabled (user requested freq strikethrough)
          const freqHtml = `<span class="${s.disabled ? 'station-disabled' : ''}">${escapeHtml(String(freqTxt))}</span>`;
          const nameHtml = `<span class="${s.disabled ? 'station-disabled' : ''}">${escapeHtml(String(s.name||''))}</span>`;

          html += `<tr class="${rowClass}" data-uid="${uid}" data-idx="${i}">
                    <td><span class="freq-clickable" data-uid="${uid}" data-idx="${i}">${freqHtml}</span></td>
                    <td class="station-name-clickable" data-uid="${uid}" data-idx="${i}">${nameHtml}</td>
                    <td>${escapeHtml(String(s.pi||''))}</td>
                    <td>${escapeHtml(String(kwTxt))}</td>
                    <td style="text-align:center">
                      <button class="cov-btn" data-uid="${uid}" data-idx="${i}" ${covBtnDisabled} style="${covActive ? 'background:#ccc' : ''}">Cov</button>
                      ${stationControlsHtml}
                    </td>
                   </tr>`;
        });

        html += `</tbody></table></div>`;
      });

      panelContentContainer.innerHTML = html;

      // attach listeners
      panelContentContainer.querySelectorAll('.add-station-btn').forEach(b=>{
        b.addEventListener('click', ev => { ev.stopPropagation(); const uid = b.dataset.uid; devAddStationByUid(uid); });
      });
      panelContentContainer.querySelectorAll('.edit-tx-btn').forEach(b=>{ b.addEventListener('click', ev => { ev.stopPropagation(); openEditModalForTxByUid(b.dataset.uid); }); });
      panelContentContainer.querySelectorAll('.del-tx-btn').forEach(b=>{ b.addEventListener('click', ev => { ev.stopPropagation(); devDeleteTxByUid(b.dataset.uid); }); });

      panelContentContainer.querySelectorAll('.edit-station-btn').forEach(b=>{
        b.addEventListener('click', ev => { ev.stopPropagation(); const uid = b.dataset.uid; const idx = Number(b.dataset.idx); devEditStationByUid(uid, idx); });
      });
      panelContentContainer.querySelectorAll('.delete-station-btn').forEach(b=>{
        b.addEventListener('click', ev => { ev.stopPropagation(); const uid = b.dataset.uid; const idx = Number(b.dataset.idx); devDeleteStationByUid(uid, idx); });
      });
      panelContentContainer.querySelectorAll('.cov-btn').forEach(b=>{
        b.addEventListener('click', ev=>{ ev.stopPropagation(); const uid=b.dataset.uid, idx=Number(b.dataset.idx); const tx = uidToTx.get(uid); if(tx){
            const s = tx.stations[idx];
            if(s && s.disabled){ return; } // disabled stations cannot toggle coverage
            toggleCoverageForStation(tx, idx, b);
          } });
      });
      panelContentContainer.querySelectorAll('.freq-clickable').forEach(el=>{
        el.addEventListener('click', ev=>{ ev.stopPropagation(); const uid=el.dataset.uid, idx=Number(el.dataset.idx); const tx = uidToTx.get(uid); if(tx){ const s = tx.stations[idx]; if(s){ document.getElementById('freq-filter-inp').value = formatFreqOneDecimal(s.freq); filterFreq = parseFloat(formatFreqOneDecimal(s.freq)); applyFilters(); } } });
      });
      panelContentContainer.querySelectorAll('.station-name-clickable').forEach(el=>{
        el.addEventListener('click', ev=>{ ev.stopPropagation(); const uid=el.dataset.uid, idx=Number(el.dataset.idx); const tx=uidToTx.get(uid); if(tx){ const s=tx.stations[idx]; if(s) filterByStation(s.name); } });
      });

      // NOTE: removed panel checkboxes + handlers â€” Disabled control is now only in the station edit modal per your request.
    }

    window.filterByStation = function(name){
      const n = (name||'').trim().toUpperCase();
      if(!n) return;
      filterStationName = (filterStationName === n) ? null : n;
      applyFilters();
      renderPanelContent();
    };

    window.applyFiltersGlobal = function(){
      // DON'T aggressively normalize freq on every call (that broke typing). Parse value but don't rewrite input here.
      const freqValStr = document.getElementById('freq-filter-inp').value.trim();
      if(freqValStr !== ''){
        const parsed = parseFloat(freqValStr);
        filterFreq = (!isNaN(parsed)) ? parsed : null;
      } else {
        filterFreq = null;
      }

      filterPI = document.getElementById('pi-filter-inp').value.trim().toUpperCase() || null;
      filterEIRP = (document.getElementById('eirp-filter-inp').value.trim() !== '') ? parseFloat(document.getElementById('eirp-filter-inp').value) : null;
      polFilter = document.getElementById('pol-filter').value || 'Any';
      markedOnly = document.getElementById('marked-only').checked;
      const countrySel = document.getElementById('country-filter').value || 'All';
      applyFilters(countrySel === 'All' ? null : countrySel);
    };

    function applyFilters(countryValue=null){
      // update icons first (updateIcon uses filterPI/filterFreq/filterStationName)
      txList.forEach(tx => updateIcon(tx));
      txList.forEach(tx => {
        const matchesName = !filterStationName || tx.stations.some(s => s.name && s.name.trim().toUpperCase() === filterStationName);
        const matchesPI = !filterPI || tx.stations.some(s => s.pi && s.pi.toUpperCase() === filterPI);
        const matchesEIRP = !filterEIRP || tx.stations.some(s => (s.kw || 0) >= filterEIRP);
        const pol = polFilter || 'Any';
        const matchesPol = (pol === 'Any') || tx.stations.some(s => s.pol && String(s.pol).trim().toUpperCase().startsWith(pol.toUpperCase()));
        const matchesFreq = !filterFreq || tx.stations.some(s => (s.freq !== undefined && Math.abs(Number(s.freq) - Number(filterFreq)) < 0.001));
        const matchesCountry = !countryValue || tx.stations.some(s => s.country && String(s.country).trim().toUpperCase() === String(countryValue).trim().toUpperCase());
        const hasCoverage = tx.stationCircles && Object.keys(tx.stationCircles).length > 0;
        const hasTrail = !!tx.line;
        const matchesMarked = !markedOnly || selectedIDs.has(tx.id) || hasTrail || hasCoverage;

        const shouldShow = matchesFreq && matchesPI && matchesEIRP && matchesName && matchesPol && matchesMarked && matchesCountry;
        if(shouldShow){ if(!map.hasLayer(tx.marker)) try{ map.addLayer(tx.marker); }catch(e){} }
        else { if(map.hasLayer(tx.marker)) try{ map.removeLayer(tx.marker); }catch(e){} }
      });

      renderPanelContent();
      populateCountryFilter();
      if(devMode) rebuildDevList();
    }

    // dev functions / UI
    function rebuildDevList(){
      devList.innerHTML = '';
      txList.forEach(tx => {
        const card = document.createElement('div'); card.className='devtools-tx';
        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div><b>${escapeHtml(tx.name||tx.id)}</b> <span style="font-size:11px;color:#666">(${escapeHtml(tx.id)})</span></div>
          <div style="display:flex;gap:6px">
            <button class="btn edit-tx-quick" data-uid="${tx.__uid}">Edit</button>
            <button class="btn del-tx-quick" data-uid="${tx.__uid}">Delete</button>
          </div></div>
          <div style="font-size:11px;margin-top:6px">Stations: ${(tx.stations||[]).map(s => escapeHtml(String(s.freq||'')) + ' ' + escapeHtml(String(s.name||'')) + (s.disabled ? ' (disabled)' : '') ).join(', ')}</div>`;
        devList.appendChild(card);
      });
      devList.querySelectorAll('.edit-tx-quick').forEach(b => b.addEventListener('click', e => openEditModalForTxByUid(b.dataset.uid)));
      devList.querySelectorAll('.del-tx-quick').forEach(b => b.addEventListener('click', e => devDeleteTxByUid(b.dataset.uid)));
    }

    // === EXPORT JSON (robust) ===
    function exportJSON(){
      try{
        if(!txList || txList.length === 0){
          return alert('No TXs to export.');
        }

        // Build a clean, serialisable copy of the data
        const out = {
          meta: {
            exportedAt: (new Date()).toISOString()
          },
          txList: txList.map(t => {
            return {
              id: t.id,
              name: t.name,
              latlng: Array.isArray(t.latlng) ? [ Number(t.latlng[0]), Number(t.latlng[1]) ] : (t.latlng || null),
              point: t.point || null,
              stations: (t.stations||[]).map(s => ({
                freq: s.freq === undefined ? '' : s.freq,
                name: s.name === undefined ? '' : s.name,
                pi: s.pi === undefined ? '' : s.pi,
                kw: s.kw === undefined ? 0 : Number(s.kw),
                pol: s.pol === undefined ? '' : s.pol,
                directional: !!s.directional,
                directionAngle: (s.directionAngle === undefined || s.directionAngle === null) ? null : Number(s.directionAngle),
                country: s.country === undefined ? '' : s.country,
                disabled: !!s.disabled
              }))
            };
          })
        };

        const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'txs-export.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }catch(err){
        console.error('Export failed:', err);
        alert('Export failed: ' + (err && err.message ? err.message : String(err)));
      }
    }

    function importJSONFile(){
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange = e => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = () => {
          try {
            const parsed = JSON.parse(r.result);
            if(!parsed.txList || !Array.isArray(parsed.txList)) return alert('Invalid JSON format');
            txList.forEach(t=>{ try{ if(t.marker) map.removeLayer(t.marker); if(t.line) map.removeLayer(t.line); Object.values(t.stationCircles||{}).forEach(c=>map.removeLayer(c.layer)); }catch(e){} });
            txList = []; uidToTx.clear();
            parsed.txList.forEach(t => createTX(t,true));
            populateCountryFilter(); applyFilters();
            if(devMode) rebuildDevList();
          } catch(err){ alert('Error parsing JSON: ' + err.message); }
        };
        r.readAsText(f);
      };
      inp.click();
    }

    document.getElementById('dev-add-tx').addEventListener('click', () => {
      if(!devMode){ alert('Enable Devtools first (âš™)'); return; }
      awaitingNewTxPlacement = !awaitingNewTxPlacement;
      document.getElementById('dev-add-tx').innerText = awaitingNewTxPlacement ? 'Cancel place' : 'Add TX';
      statusLineContainer.innerText = awaitingNewTxPlacement ? 'Click the map to place a new TX. Click "Cancel place" to abort.' : 'Ready.';
    });
    document.getElementById('dev-export').addEventListener('click', exportJSON);
    document.getElementById('dev-import').addEventListener('click', importJSONFile);

    // freq stepper logic (band-aware)
    const freqIncBtn = document.getElementById('freq-inc');
    const freqDecBtn = document.getElementById('freq-dec');
    const freqInput = document.getElementById('freq-filter-inp');

    function stepFreq(delta){
      // delta in MHz (e.g. +0.1 or -0.1)
      let cur = null;
      const v = freqInput.value.trim();
      if(v !== ''){
        const p = parseFloat(v);
        if(!isNaN(p)) cur = p;
      }
      if(cur === null){
        cur = (filterFreq !== null && !isNaN(filterFreq)) ? filterFreq : 87.4;
      }

      // --- OIRT behaviour: ADD/SUB 0.03 from current value (preserve offset)
      if(isInOirtBand(cur) || (cur + delta >= OIRT_MIN && cur + delta <= OIRT_MAX)){
        const step = OIRT_STEP;
        const dir = delta > 0 ? 1 : -1;
        let next = cur + dir * step;
        if(next < OIRT_MIN) next = OIRT_MIN;
        if(next > OIRT_MAX) next = OIRT_MAX;
        // round to 2 decimals for nice display (e.g. 72.05)
        next = Math.round(next * 100) / 100;
        freqInput.value = next.toFixed(2);
        filterFreq = Number(freqInput.value);
        applyFilters();
        return;
      }

      // --- NWR behaviour: step through exact channels
      if(isInNwrBand(cur) || (cur + delta >= 162.4 && cur + delta <= 162.55)){
        // find nearest channel index
        let bestIdx = 0, bestDiff = Math.abs(cur - NWR_CHANNELS[0]);
        for(let i=0;i<NWR_CHANNELS.length;i++){
          const d = Math.abs(cur - NWR_CHANNELS[i]);
          if(d < bestDiff){ bestDiff = d; bestIdx = i; }
        }
        const dir = delta > 0 ? 1 : -1;
        let nextIdx = bestIdx + dir;
        if(nextIdx < 0) nextIdx = 0;
        if(nextIdx >= NWR_CHANNELS.length) nextIdx = NWR_CHANNELS.length - 1;
        const next = NWR_CHANNELS[nextIdx];
        freqInput.value = next.toFixed(3);
        filterFreq = Number(freqInput.value);
        applyFilters();
        return;
      }

      // default behaviour: 0.1 MHz steps
      const next = Math.round((cur + delta) * 10) / 10;
      const norm = formatFreqOneDecimal(next);
      freqInput.value = norm;
      filterFreq = parseFloat(norm);
      applyFilters();
    }

    freqIncBtn.addEventListener('click', ()=> stepFreq(0.1));
    freqDecBtn.addEventListener('click', ()=> stepFreq(-0.1));

    // when user types in freq box, don't reformat on every keystroke (that broke typing)
    freqInput.addEventListener('input', () => {
      const v = freqInput.value.trim();
      const p = parseFloat(v);
      filterFreq = (!isNaN(p)) ? p : null;
      // update filters live but don't force a reformat of the input
      applyFilters();
    });
    // normalize on blur (user finished typing) so display is consistent
    freqInput.addEventListener('blur', () => {
      normalizeFreqDisplay();
      applyFilters();
    });

    map.on('click', e => {
      if(awaitingNewTxPlacement){
        const latlng = e.latlng;
        const created = createTX({ name:'New TX', latlng:[latlng.lat, latlng.lng], stations:[]});
        awaitingNewTxPlacement = false;
        document.getElementById('dev-add-tx').innerText = 'Add TX';
        populateCountryFilter(); applyFilters(); openEditModalForTxByUid(created.__uid);
        return;
      }
      if(selectedIDs.size > 0){
        selectedIDs.forEach(id => { const t = txList.find(x=>x.id===id); if(t){ selectedIDs.delete(id); updateIcon(t); }});
        renderPanelContent();
      }
    });

    map.on('contextmenu', e => {
      if(rx) return;
      rx = L.marker(e.latlng, { icon: icons.rx, draggable:true }).addTo(map);
      rx.on('dragend', () => { txList.forEach(t => t.line && drawTrail(t)); renderPanelContent(); });
      renderPanelContent();
    });

    const modal = document.getElementById('edit-modal');
    const modalTitle = document.getElementById('edit-modal-title');
    const modalBody = document.getElementById('edit-modal-body');
    const modalSave = document.getElementById('edit-save');
    const modalCancel = document.getElementById('edit-cancel');
    let modalContext = null;

    function openEditModalForTxByUid(uid){
      const tx = uidToTx.get(uid);
      if(!tx) return alert('TX not found');
      modalContext = { type:'tx', uid };
      modalTitle.innerText = `Edit TX: ${tx.name || tx.id}`;
      let html = `<label>TX id (readonly)</label><input readonly value="${escapeHtml(tx.id)}" />
                  <label>TX Name</label><input id="edit-tx-name" value="${escapeHtml(tx.name||'')}" />
                  <label>Latitude</label><input id="edit-tx-lat" value="${tx.latlng?tx.latlng[0]:0}" />
                  <label>Longitude</label><input id="edit-tx-lon" value="${tx.latlng?tx.latlng[1]:0}" />
                  <div style="margin-top:6px;font-weight:bold">Stations</div>
                  <div id="edit-stations-list">`;
      (tx.stations||[]).forEach((s,i)=>{
        html += `<div style="border:1px dashed #eee;padding:6px;margin:6px 0">
                  <div style="display:flex;gap:6px">
                    <div style="flex:1">${i+1}. <b>${escapeHtml(s.name||'')}</b> (${escapeHtml(String(s.freq||''))}) ${s.disabled ? '<span style="color:#a00;font-size:11px">[disabled]</span>' : ''}</div>
                    <div style="display:flex;gap:6px">
                      <button class="btn edit-station-in-modal" data-uid="${uid}" data-idx="${i}">Edit</button>
                      <button class="btn del-station-in-modal" data-uid="${uid}" data-idx="${i}">Delete</button>
                    </div>
                  </div>
                </div>`;
      });
      html += `</div><div style="display:flex;gap:6px;margin-top:6px"><button class="btn" id="edit-add-station">Add station</button></div>`;
      modalBody.innerHTML = html;
      modal.style.display = 'block';

      document.getElementById('edit-add-station').onclick = () => {
        const newS = { freq:'', pol:'Any', name:'New Station', pi:'', kw:0, directional:false, directionAngle:null, country:'', disabled:false };
        tx.stations.push(newS);
        openEditModalForTxByUid(uid);
        devEditStationByUid(uid, tx.stations.length - 1);
      };

      Array.from(modalBody.querySelectorAll('.edit-station-in-modal')).forEach(btn => btn.addEventListener('click', ev => {
        const idx = Number(btn.dataset.idx); devEditStationByUid(uid, idx);
      }));
      Array.from(modalBody.querySelectorAll('.del-station-in-modal')).forEach(btn => btn.addEventListener('click', ev => {
        const idx = Number(btn.dataset.idx); devDeleteStationByUid(uid, idx); openEditModalForTxByUid(uid);
      }));

      modalSave.onclick = () => {
        const name = document.getElementById('edit-tx-name').value;
        const lat = parseFloat(document.getElementById('edit-tx-lat').value);
        const lon = parseFloat(document.getElementById('edit-tx-lon').value);
        tx.name = name;
        if(!isNaN(lat) && !isNaN(lon)){ tx.latlng = [lat, lon]; if(tx.marker) tx.marker.setLatLng(L.latLng(lat, lon)); }
        if(tx.stations && tx.stations.length) tx.stations.sort((a,b)=> (Number(a.freq)||0) - (Number(b.freq)||0));
        closeModal();
        populateCountryFilter();
        applyFilters();
      };
      modalCancel.onclick = closeModal;
    }

    function devEditStationByUid(uid, idx){
      const tx = uidToTx.get(uid);
      if(!tx) return alert('TX not found');
      const s = tx.stations[idx];
      if(!s) return alert('Station not found');
      modalContext = { type:'station', uid, idx };
      modalTitle.innerText = `Edit Station: ${s.name||''}`;
      modalBody.innerHTML = `
        <label>Station name</label><input id="edit-st-name" value="${escapeHtml(s.name||'')}" />
        <label>Freq (MHz)</label><input id="edit-st-freq" value="${escapeHtml(String(s.freq||''))}" />
        <label>Pol</label><input id="edit-st-pol" value="${escapeHtml(s.pol||'')}" />
        <label>PI</label><input id="edit-st-pi" value="${escapeHtml(s.pi||'')}" />
        <label>kW</label><input id="edit-st-kw" value="${s.kw !== undefined && s.kw !== null ? s.kw : 0}" />
        <label>Country</label><input id="edit-st-country" value="${escapeHtml(s.country||'')}" />
        <div class="row">
          <label style="display:block"><input type="checkbox" id="edit-st-dir" ${s.directional ? 'checked' : ''} /> Directional</label>
          <input id="edit-st-az" placeholder="Azimuth (0-359)" value="${s.directionAngle !== null && s.directionAngle !== undefined ? s.directionAngle : ''}" />
        </div>
        <div style="margin-top:6px"><label><input type="checkbox" id="edit-st-disabled" ${s.disabled ? 'checked' : ''} /> Disabled</label></div>
      `;
      modal.style.display = 'block';
      modalSave.onclick = () => {
        s.name = document.getElementById('edit-st-name').value;
        s.freq = (document.getElementById('edit-st-freq').value || '').toString();
        s.pol = document.getElementById('edit-st-pol').value;
        s.pi = document.getElementById('edit-st-pi').value;
        const kwv = parseFloat(document.getElementById('edit-st-kw').value); s.kw = isNaN(kwv) ? 0 : kwv;
        s.country = document.getElementById('edit-st-country').value;
        s.directional = !!document.getElementById('edit-st-dir').checked;
        const az = parseInt(document.getElementById('edit-st-az').value,10); s.directionAngle = (!isNaN(az) && az>=0 && az<=359) ? az : null;
        // save disabled flag
        const newDisabled = !!document.getElementById('edit-st-disabled').checked;
        s.disabled = newDisabled;

        // if disabling, remove coverage for that station and disable cov button
        if(s.disabled){
          try{
            if(tx.stationCircles && tx.stationCircles[idx]){ map.removeLayer(tx.stationCircles[idx].layer); delete tx.stationCircles[idx]; }
          }catch(e){}
        }

        if(tx.stations && tx.stations.length) tx.stations.sort((a,b)=> (Number(a.freq)||0) - (Number(b.freq)||0));
        // update marker opacity if all stations disabled
        try{ const allDisabled = (tx.stations && tx.stations.length) ? tx.stations.every(s=>!!s.disabled) : false; if(tx.marker) tx.marker.setOpacity(allDisabled?0.5:1); }catch(e){}
        closeModal();
        populateCountryFilter();
        applyFilters();
      };
      modalCancel.onclick = closeModal;
    }

    function devDeleteStationByUid(uid, idx){
      const tx = uidToTx.get(uid);
      if(!tx) return alert('TX not found');
      if(!confirm('Delete station?')) return;
      tx.stations.splice(idx,1);
      populateCountryFilter();
      applyFilters();
      if(devMode) rebuildDevList();
    }

    function devAddStationByUid(uid){
      const tx = uidToTx.get(uid);
      if(!tx) return alert('TX not found');
      const newS = { freq:'', pol:'Any', name:'New Station', pi:'', kw:0, directional:false, directionAngle:null, country:'', disabled:false };
      tx.stations.push(newS);
      devEditStationByUid(uid, tx.stations.length - 1);
    }

    function devDeleteTxByUid(uid){
      const tx = uidToTx.get(uid);
      if(!tx) return alert('TX not found');
      if(!confirm('Delete TX and all its stations?')) return;
      try{ if(tx.marker) map.removeLayer(tx.marker); if(tx.line) map.removeLayer(tx.line); Object.values(tx.stationCircles||{}).forEach(c=>map.removeLayer(c.layer)); }catch(e){}
      const idx = txList.findIndex(t=>t.__uid===uid);
      if(idx !== -1) txList.splice(idx,1);
      uidToTx.delete(uid);
      applyFilters();
      if(devMode) rebuildDevList();
    }

    function closeModal(){ modal.style.display='none'; modalContext=null; modalSave.onclick=null; modalCancel.onclick=null; }
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    devToggle.addEventListener('click', ()=>{ devMode = !devMode; devPanel.style.display = devMode ? 'block':'none'; devToggle.style.background = devMode ? '#eee':'#fff'; if(devMode) rebuildDevList(); renderPanelContent(); });

    function populateCountryFilter(){
      const sel = document.getElementById('country-filter'); const prev = sel.value || 'All';
      const set = new Set(); txList.forEach(tx => (tx.stations||[]).forEach(s => { if(s.country) set.add(String(s.country).trim().toUpperCase()); }));
      const arr = Array.from(set).sort();
      sel.innerHTML = '<option>All</option>' + arr.map(a => `<option>${a}</option>`).join('');
      if(arr.indexOf(String(prev).trim().toUpperCase()) !== -1) sel.value = prev;
    }

    async function loadDBFromUrl(url){
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const loaded = await res.json();
        if(!loaded || !Array.isArray(loaded.txList)) throw new Error('Invalid JSON: missing txList array');
        txList.forEach(t=>{ try{ if(t.marker) map.removeLayer(t.marker); if(t.line) map.removeLayer(t.line); Object.values(t.stationCircles||{}).forEach(c=>map.removeLayer(c.layer)); }catch(e){} });
        txList = []; uidToTx.clear();
        loaded.txList.forEach(t => { if(t.point || t.latlng || (typeof t.lat === 'number' && typeof t.lon === 'number')) createTX(t, true); });
        populateCountryFilter(); applyFilters();
        console.info('Loaded DB:', url, 'TX count:', txList.length);
      }catch(err){
        console.error('Could not load remote DB:', err);
      }
    }

    // default loader (you can remove/change if needed)
    loadDBFromUrl('https://raw.githubusercontent.com/frenchkiddo6969/f/refs/heads/main/txs.json');

    window._weimc = { txList, uidToTx, createTX, applyFilters, renderPanelContent, loadDBFromUrl };

    // wire filter inputs (PI/EIRP/pol/marked/country)
    document.getElementById('pi-filter-inp').addEventListener('input', applyFiltersGlobal);
    document.getElementById('eirp-filter-inp').addEventListener('input', applyFiltersGlobal);
    document.getElementById('pol-filter').addEventListener('change', applyFiltersGlobal);
    document.getElementById('marked-only').addEventListener('change', applyFiltersGlobal);
    document.getElementById('country-filter').addEventListener('change', () => applyFilters(document.getElementById('country-filter').value === 'All' ? null : document.getElementById('country-filter').value));

    setInterval(()=>{ debugBadge.innerText = `TXs: ${txList.length} | Visible: ${txList.filter(t=>map.hasLayer(t.marker)).length}`; }, 1500);

    // initial render
    renderPanelContent();
    populateCountryFilter();

    console.info('weimc helper: use window._weimc to inspect txList and helper functions.');
  })();
  </script>
</body>
</html>
